# Go アプリケーション

これは、環境を意識した設定可能なロギングを備えたシンプルな Go アプリケーションです。

## 前提条件

このプロジェクトは Go バージョン 1.24.5 でテストされています。 `go version` で Go のバージョンを確認できます。

### 特定の Go バージョンの設定

手元で使っている `go` コマンドのバージョンが `1.24.5` でない場合は、次の方法で `go1.24.5` コマンドをインストールし、`go` コマンドの代りにそちらを使用すること。

```bash
# Go バージョンインストーラーをインストール
go install golang.org/dl/go1.24.5@latest

# SDK をダウンロード
go1.24.5 download

# これで go1.24.5 コマンドが使用可能
go1.24.5 version
```

## 説明

このアプリケーションは、Go プロジェクトの一般的なセットアップを示しています。

- **設定管理**: `viper` を使用して YAML ファイルから設定をロードします。
- **ロギング**: `zerolog` を使用して構造化されたレベル付きロギングを行います。
- **環境固有のロジック**: `APP_ENV` 環境変数に基づいて動作を変更します。

## ディレクトリ構成

```text
goapp001/
├── GEMINI.md ... Gemini CLI 向けドキュメント
├── README.md ... 開発者向けドキュメント
├── app.go ... アプリケーションの処理
├── app_test.go ... app.go のテスト用コード
├── conf/ ... 設定ファイル用フォルダ
│   └── config.yaml
├── config/ ... 設定関連の処理用
│   ├── config.go
│   └── config_test.go
├── docker/ ... Docker 用フォルダ
│   ├── README.md
│   ├── cicd/
│   ├── demo/
│   └── prod/
├── go.mod ... Go モジュール用ファイル
├── go.sum ... Go モジュールロック用ファイル
├── goapp001.code-workspace ... VS Code ワークスペースファイル
├── log/ ... ログ出力用フォルダ
│   └── app.log
├── logger/ ... ログ処理用
│   └── logger.go
├── main.go ... メイン処理
└── sample/ ... サンプル用フォルダ
    ├── config.dev.yaml ... 開発向け設定ファイル
    ├── config.prod.yaml ... 運用向け設定ファイル
    └── config.yaml ... デフォルト設定ファイル
```

## 設定

アプリケーションは `conf/config.yaml` ファイルと環境変数を介して設定されます。

設定の優先順位は次のとおりです。

1. 環境変数 (例: `APP_LEVEL`)
2. `conf/config.yaml` ファイル
3. コード内で定義されたデフォルト値

### 設定ファイル (`conf/config.yaml`)

基本的な設定値を提供します。

```yaml
level: info
logdir: log
logfile: app.log
```

- `level`: 記録する最小ログレベル (`debug`, `info`, `warn`, `error`)。
- `logdir`: ログファイルのディレクトリ。
- `logfile`: ログファイルの名前。

### 環境変数による上書き

すべての設定値は、`APP_` プレフィックスを付けた環境変数で上書きできます。例えば、ログレベルを `debug` に変更するには、次のようにします。

```bash
export APP_LEVEL=debug
```

## アプリケーションの実行

正しいGoバージョンがあれば、アプリケーションを実行できます。

### 開発モード

`APP_ENV` が `prod` 以外に設定されている場合、ログはコンソールとログファイルの両方に出力されます。

```bash
# 開発モードで実行
APP_ENV=dev go run .
```

ログレベルをデバッグにしたい場合は、環境変数で上書きできます。

```bash
# ログレベルを上書きして開発モードで実行
APP_ENV=dev APP_LEVEL=debug go run .
```

### 本番モード

本番モードで実行するには、 `APP_ENV` を `prod` に設定します。ログは指定されたファイルにのみ書き込まれます。

```bash
# 本番モードで実行
APP_ENV=prod go run .
```

## テスト

このプロジェクトには、アプリケーションロジック (`app_test.go`) と設定パッケージ (`config/config_test.go`) の単体テストが含まれています。

すべてのパッケージのテストを実行するには、次のコマンドを使用します。

```bash
# すべてのテストを実行
go test ./...
```

実行されたテスト関数の名前など、より詳細な出力を得るには、 `-v` （詳細）フラグを使用します。

```bash
# 詳細な出力ですべてのテストを実行
go test -v ./...
```

## デバッグ

このプロジェクトでは、 `go.mod` の `tool` ディレクティブを使用してDelveデバッガーのバージョンを管理します。これにより、すべての開発者が同じバージョンのツールを使用することが保証されます。

### 1. 実行方法

デバッグセッションを開始するには、 `go run` コマンドを使用して `go.mod` で指定されたバージョンのDelveを実行します。

```bash
go run github.com/go-delve/delve/cmd/dlv debug
```

これにより、デバッガー内でアプリケーションがコンパイルおよび実行されます。 `(dlv)` プロンプトで示されるDelveコマンドラインインターフェイスに移動します。

### 2. 基本コマンド

最も一般的に使用するコマンドのいくつかを次に示します。

- `b <file>:<line>`: 特定のファイルと行にブレークポイントを設定します。
- `c`: ブレークポイントに到達するか、プログラムが終了するまで実行を続行します。
- `n`: 次のコード行にステップします。
- `p <variable>`: 変数の値を表示します。
- `q`: デバッガーを終了します。

### 3. セッション例

`Run` 関数の先頭にブレークポイントを設定し、コードのステップ実行を開始する方法の例を次に示します。

1. Delveを開始します。
2. `app.go` の `Run` 関数の最初の行にブレークポイントを設定します。
3. ブレークポイントまで実行を続行します。
4. 次の行にステップします。
5. セッションを終了します。

Delveを開始するには、`dlv debug` を実行。Go の tool を使う場合は下記。

```bash
go run github.com/go-delve/delve/cmd/dlv debug
```

ブレイクポイントの設定例。`app.go` の 8 行目にブレイクポイントを設定。

```bash
(dlv) b app.go:8
```

継続の `c` を入力。

```bash
(dlv) c
```

プログラムは指定した行で一時停止します。次の行にステップするには `n` を入力。

```bash
(dlv) n
```

セッションを終了するには `q` を入力。

```bash
(dlv) q
```

## コードドキュメント

標準のGoツールである `godoc` を使用して、ローカルでコードのドキュメントを閲覧できます。ソースコードのコメントからドキュメントを生成します。

1. godoc サーバーを起動
2. ブラウザでドキュメントを表示

godoc サーバーを起動するには、`-http` オプションを指定しながら `godoc` コマンドを実行。

```bash
godoc -http=:6060
```

Webブラウザを開き、次の URL へアクセスします。

- <http://localhost:6060/pkg/go.dev.internal/goapp001/>
